{% extends "base.html" %}
{% block content %}
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-3">
        <div>
          <h2 class="h4 text-white fw-semibold mb-0">Process Flow</h2>
          {% if issue %}
            <div class="text-soft small">{{ issue.key }}: {{ issue.summary }}</div>
          {% endif %}
        </div>
        <div class="d-flex gap-2">
          {% if issue %}
            <a class="btn btn-sm btn-light" href="{{ issue.url }}" target="_blank">Open in JIRA</a>
          {% endif %}
          <a class="btn btn-sm btn-outline-light" href="{{ url_for('describe_process') }}">Back</a>
        </div>
      </div>

      {% if error_message %}
        <div class="rounded-4 bg-blur text-white p-3 p-md-4">
          <div class="alert alert-danger mb-0">
            <strong>Error:</strong> {{ error_message }}
          </div>
        </div>
      {% elif issue %}
        <div class="row g-3">
          <div class="col-md-4">
            <div class="rounded-4 bg-blur text-white p-3 p-md-4 h-100">
              <div class="fw-semibold mb-2">Task Details</div>
              <div class="mb-2">
                <span class="text-soft small">Key:</span>
                <a href="{{ issue.url }}" target="_blank" class="text-info text-decoration-none">{{ issue.key }}</a>
              </div>
              <div class="mb-2">
                <span class="text-soft small">Status:</span>
                <span class="badge text-bg-primary">{{ issue.status }}</span>
              </div>
              <div class="mb-3">
                <span class="text-soft small d-block mb-1">Description:</span>
                <div id="description-text" class="small" style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                  {% if issue.description %}
                    {{ issue.description }}
                  {% else %}
                    <span class="text-soft">No description available</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="rounded-4 bg-blur text-white p-3 p-md-4 h-100">
              <div class="fw-semibold mb-3">AI-Generated Process Flow</div>
              
              {% if process_steps %}
                <!-- Auto-generated diagram -->
                <div class="mermaid-container" style="background: white; border-radius: 8px; padding: 20px; min-height: 200px;">
                  <pre class="mermaid">{{ process_steps }}</pre>
                </div>
                <div class="mt-3">
                  <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#mermaidCode">
                    Show Mermaid Code
                  </button>
                  <div class="collapse mt-2" id="mermaidCode">
                    <pre style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; font-size: 12px; overflow-x: auto;">{{ process_steps }}</pre>
                  </div>
                </div>
              {% elif not gemini_configured %}
                <!-- No API key configured -->
                <div class="alert alert-warning small mb-3">
                  <strong>LLM API not configured.</strong><br>
                  Add <code>GROQ_API_KEY</code> or <code>GEMINI_API_KEY</code> to your .env file to enable automatic diagram generation.
                </div>
              {% else %}
                <!-- API configured but generation failed or no description -->
                {% if gemini_error %}
                  <div class="alert alert-warning small">
                    <strong>API Error</strong>
                    <p class="mb-2">{{ gemini_error }}</p>
                    <button class="btn btn-primary btn-sm" onclick="location.reload()">
                      Retry
                    </button>
                  </div>
                {% else %}
                  <div class="text-soft">
                    No description available in JIRA task. Add a description to generate a process flow.
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Mermaid.js for rendering diagrams -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({ 
      startOnLoad: true,
      theme: 'default',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      }
    });
  </script>
  
  <!-- Bootstrap JS for collapse -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
